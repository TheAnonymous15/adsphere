<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Home | AdSphere</title> <script src="https://cdn.tailwindcss.com"></script> </head> <body class="bg-gradient-to-br from-purple-900 via-indigo-800 to-black min-h-screen font-sans flex flex-col items-center justify-center"> <!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>AdSphere | The Future of Digital Advertising</title> <link rel="icon" type="image/png" href="/app/assets/images/adsphere.ico"> <script src="https://cdn.tailwindcss.com"></script> <link rel="stylesheet" href="/app/assets/css/all.min.css"> <style>
        /* Shared Classes */
        .nav-link {
            @apply text-white/90 hover:text-white font-medium transition-all hover:-translate-y-0.5;
        }
        .mobile-link {
            @apply block px-6 py-3 text-gray-800/90 hover:bg-white/30 hover:text-indigo-600 transition;
        }

        /* Hero Gradient Animation */
        .animated-gradient {
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #d946ef);
            background-size: 400% 400%;
            animation: gradientShift 10s ease infinite;
        }

        /* Body Background Gradient */
        body {
            background: linear-gradient(135deg, #0b927e, #0b343b, #119585);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style> </head> <body class="text-gray-900 font-sans leading-relaxed scroll-smooth"> <!-- ============================================ --> <!-- HEADER / NAVIGATION --> <!-- ============================================ --> <header class="fixed top-0 left-0 w-full z-50 backdrop-blur-xl bg-white/10 border-b border-white/20 shadow-lg"> <nav class="max-w-7xl mx-auto px-6 flex items-center justify-between h-20"> <!-- Branding --> <div class="flex items-center space-x-4 group cursor-pointer"> <div class="p-1 rounded-xl bg-white/20 backdrop-blur-lg shadow-md transition-transform group-hover:scale-105"> <img src="/app/assets/images/icc.png" alt="AdSphere Logo" class="h-12 w-auto object-contain"> </div> </div> <!-- Desktop Menu --> <div class="hidden md:flex items-center space-x-8"> <a href="#features" class="nav-link">Features</a> <a href="#marketplace" class="nav-link">Marketplace</a> <a href="#pricing" class="nav-link">Pricing</a> <a href="#testimonials" class="nav-link">Testimonials</a> <a href="#faq" class="nav-link">FAQ</a> <a href="#signup" class="px-5 py-2.5 bg-white text-indigo-600 rounded-xl font-semibold shadow hover:shadow-lg transition-all hover:-translate-y-0.5">Signup</a> <a href="/app/companies/handlers/login.php" class="px-5 py-2.5 border border-white/70 text-white rounded-xl font-semibold hover:bg-white hover:text-indigo-700 transition-all hover:-translate-y-0.5">Login</a> </div> <!-- Mobile Menu Button --> <button id="mobile-menu-button" class="md:hidden focus:outline-none text-white"> <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/> </svg> </button> </nav> <!-- Mobile Menu --> <div id="mobile-menu" class="hidden md:hidden bg-white/20 backdrop-blur-lg border-t border-white/10 shadow-xl"> <a href="#features" class="mobile-link">Features</a> <a href="#marketplace" class="mobile-link">Marketplace</a> <a href="#pricing" class="mobile-link">Pricing</a> <a href="#testimonials" class="mobile-link">Testimonials</a> <a href="#faq" class="mobile-link">FAQ</a> <a href="#signup" class="mobile-link font-semibold text-indigo-600">Signup</a> <a href="/app/companies/handlers/login.php" class="mobile-link font-semibold text-indigo-600">Login</a> </div> </header> <!-- ============================================ --> <!-- HERO SECTION --> <!-- ============================================ --> <section class="relative animated-gradient text-white overflow-hidden pt-24 w-full h-auto"> <div class="max-w-7xl mx-auto px-6 py-24 grid grid-cols-1 md:grid-cols-2 gap-12"> <!-- LEFT COLUMN --> <div class="flex flex-col justify-between h-full gap-8"> <!-- Branding / Headline --> <div class="space-y-6 text-center md:text-left"> <h1 class="text-5xl md:text-6xl font-extrabold leading-tight drop-shadow-lg"> The Future of Digital Advertising </h1> <p class="text-xl md:text-2xl text-indigo-100 drop-shadow-sm"> Create, manage, and deploy ads with AI-powered automation. Upload once, generate multiple formats, and scale performance automatically. </p> <div class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start mt-6"> <a href="#ads-feed" class="px-6 py-3 bg-white text-indigo-600 font-semibold rounded-xl shadow-lg transform transition hover:-translate-y-1 hover:shadow-2xl"> Browse Ads </a> <a href="/app/companies/handlers/login.php" class="px-6 py-3 border border-white text-white rounded-xl font-semibold hover:bg-white hover:text-indigo-600 transition transform hover:-translate-y-1"> Post Your Ad </a> </div> </div> <!-- Boost Subsection --> <div class="w-full bg-white/10 backdrop-blur-md rounded-2xl p-6 shadow-lg flex flex-col gap-4"> <h3 class="text-xl md:text-2xl font-bold text-white">Boost Your Ads Instantly</h3> <p class="text-indigo-100 text-sm md:text-base"> With AdSphere, you can automate campaigns, track performance, and scale your ad spend efficiently‚Äîall in one platform. </p> <a href="#ads-feed" class="mt-2 px-4 py-2 bg-indigo-500 text-white font-semibold rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-0.5 w-max"> Explore Now </a> </div> </div> <!-- RIGHT COLUMN --> <div class="flex flex-col justify-between h-full gap-8"> <!-- Video Section --> <div class="w-full rounded-3xl shadow-2xl overflow-hidden"> <div class="relative h-72 md:h-96 w-full rounded-2xl overflow-hidden"> <video autoplay muted loop playsinline class="w-full h-full object-cover"> <source src="/app/assets/videos/ad.webm" type="video/webm"> Your browser does not support the video tag. </video> </div> </div> <!-- Stats / Timeline --> <div class="relative max-w-full"> <!-- Timeline Line --> <div class="absolute top-1/2 transform -translate-y-1/2 left-0 right-0 h-1 bg-white/20"></div> <div class="flex justify-between items-center relative z-10 text-white"> <!-- Stat 1 --> <div class="flex flex-col items-center text-center w-1/3"> <div class="p-4 rounded-full bg-gradient-to-tr from-indigo-500 to-pink-500 flex items-center justify-center text-2xl shadow-lg transform transition-transform hover:scale-110"> <i class="fas fa-bullhorn"></i> </div> <div class="mt-4 text-3xl md:text-4xl font-extrabold">+12k</div> <div class="text-indigo-100 text-sm md:text-base mt-1">Ads Created</div> </div> <!-- Stat 2 --> <div class="flex flex-col items-center text-center w-1/3"> <div class="p-4 rounded-full bg-gradient-to-tr from-indigo-500 to-pink-500 flex items-center justify-center text-2xl shadow-lg transform transition-transform hover:scale-110"> <i class="fas fa-chart-line"></i> </div> <div class="mt-4 text-3xl md:text-4xl font-extrabold">65%</div> <div class="text-indigo-100 text-sm md:text-base mt-1">Avg Performance Boost</div> </div> <!-- Stat 3 --> <div class="flex flex-col items-center text-center w-1/3"> <div class="p-4 rounded-full bg-gradient-to-tr from-indigo-500 to-pink-500 flex items-center justify-center text-2xl shadow-lg transform transition-transform hover:scale-110"> <i class="fas fa-dollar-sign"></i> </div> <div class="mt-4 text-3xl md:text-4xl font-extrabold">$2.4M</div> <div class="text-indigo-100 text-sm md:text-base mt-1">Ad Spend Optimized</div> </div> </div> </div> </div> </div> </section> <!-- ============================================ --> <!-- ADS FEED SECTION --> <!-- ============================================ --> <section id="ads-feed" class="w-full text-white mt-20"> <!-- FILTERS --> <div class="sticky top-0 bg-black/30 backdrop-blur-xl shadow py-4 z-50"> <div class="max-w-7xl mx-auto flex justify-between items-center px-3 gap-3 flex-wrap"> <div class="relative flex-1 min-w-[200px]"> <input id="search" class="text-black px-3 py-2 rounded w-full pr-12" placeholder="Search ads or speak..."> <button id="voiceSearchBtn" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-indigo-600 hover:bg-indigo-700 flex items-center justify-center transition-all" title="Voice Search"> <i class="fas fa-microphone text-white text-sm"></i> </button> </div> <select id="categoryFilter" class="text-black rounded px-3 py-2"> <option value="">All</option> </select> <select id="sortFilter" class="text-black rounded px-3 py-2"> <option value="date">Latest</option> <option value="views">Most Viewed</option> <option value="favs">Favorites</option> <option value="ai">AI Recommended</option> </select> <button id="btnSearch" class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700 font-semibold"> Go </button> </div> <!-- Voice Search Status --> <div id="voiceStatus" class="hidden max-w-7xl mx-auto px-3 mt-2"> <div class="bg-indigo-600/20 border border-indigo-600 rounded-lg px-4 py-2 text-sm flex items-center gap-2"> <i class="fas fa-microphone-alt animate-pulse"></i> <span id="voiceStatusText">Listening...</span> </div> </div> </div> <h2 class="text-3xl font-bold mt-10 mb-4 px-4"> Latest Ads </h2> <p id="no-results" class="hidden text-center text-gray-300 py-12 text-lg"> No ads found. </p> <!-- cards --> <div id="ads-grid" class="columns-1 sm:columns-2 md:columns-3 lg:columns-4 gap-4 space-y-4 px-3"> </div> <!-- loading --> <div id="loading" class="hidden py-10 space-y-4"> <div class="animate-pulse flex flex-col gap-4"> <div class="rounded-xl bg-white/10 h-60"></div> <div class="rounded bg-white/10 h-4 w-3/4"></div> <div class="rounded bg-white/10 h-4 w-1/2"></div> </div> </div> </section> <!-- ===================== CONTACT MODAL ===================== --> <div id="contactDealerModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50"> <div id="contactDealerCard" class="w-11/12 max-w-lg rounded-2xl bg-slate-900 p-8 shadow-xl transform scale-95 opacity-0 transition-all duration-300"> <!-- HEADER --> <div class="mb-5 flex items-center justify-between"> <h3 class="text-lg font-bold text-white">Contact Seller</h3> <button id="closeDealerModalBtn" class="text-white text-xl hover:text-gray-300">&times;</button> </div> <!-- YOUR INFO --> <div class="mb-4 space-y-3"> <input id="senderName" type="text" placeholder="Your Name" maxlength="50" class="w-full rounded-xl border border-gray-700 bg-slate-800 p-3 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"> <input id="senderContact" type="text" placeholder="Your Phone/Email" maxlength="50" class="w-full rounded-xl border border-gray-700 bg-slate-800 p-3 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"> </div> <!-- MESSAGE --> <textarea id="contactDealerMessage" rows="8" placeholder="Type your message..." maxlength="500" class="mb-2 w-full rounded-xl border border-gray-700 bg-slate-800 p-3 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none text-sm"></textarea> <div class="text-xs text-gray-400 text-right mb-4"> <span id="charCount">0</span>/500 characters </div> <!-- ACTION BUTTONS --> <div class="grid grid-cols-2 gap-2"> <button id="sendDealerWhatsApp" class="rounded bg-green-600 py-2 font-semibold hover:bg-green-700">WhatsApp</button> <button id="sendDealerSMS" class="rounded bg-blue-600 py-2 font-semibold hover:bg-blue-700">SMS</button> <button id="sendDealerEmail" class="rounded bg-indigo-600 py-2 font-semibold hover:bg-indigo-700">Email</button> <button id="callDealerNow" class="rounded bg-red-600 py-2 font-semibold hover:bg-red-700">Call</button> </div> </div> </div> <script>
/*
  ============================================
  ADS FEED SCRIPT (REWRITTEN & FIXED)
  - Fixes modal button click issues
  - Proper event propagation handling
  - Clean structure & comments
  ============================================
*/

// ==============================
// DEBUGGING SYSTEM
// ==============================
const DEBUG = true; // Set to false to disable all debug logs

function debugLog(category, message, data = null) {
  if (!DEBUG) return;

  const emoji = {
    'init': 'üöÄ',
    'element': 'üîç',
    'api': 'üì°',
    'response': 'üì•',
    'render': 'üé®',
    'success': '‚úÖ',
    'error': '‚ùå',
    'warning': '‚ö†Ô∏è',
    'info': '‚ÑπÔ∏è',
    'data': 'üìä'
  };

  const icon = emoji[category] || 'üìù';
  const timestamp = new Date().toLocaleTimeString();

  console.log(`[${timestamp}] ${icon} ${category.toUpperCase()}: ${message}`);
  if (data !== null) {
    console.log('  ‚îî‚îÄ Data:', data);
  }
}

// Log script start
debugLog('init', 'Ad page script loading...');

// ==============================
// GLOBAL STATE
// ==============================

let page = 1;
let loading = false;
let finished = false;
let q = "";
let category = "";
let sort = "date";

debugLog('init', 'Global state initialized', { page, loading, finished, q, category, sort });

let favs = [];
try {
  debugLog('init', 'Loading favorites from localStorage...');
  const stored = localStorage.getItem("ads_favorites");
  if (stored) {
    const parsed = JSON.parse(stored);
    // Validate that it's an array and contains only strings
    if (Array.isArray(parsed) && parsed.every(item => typeof item === 'string')) {
      // Limit array size to prevent DoS
      favs = parsed.slice(0, 1000);
      debugLog('success', `Loaded ${favs.length} favorites`);
    }
  } else {
    debugLog('info', 'No favorites found in localStorage');
  }
} catch (e) {
  debugLog('error', 'Failed to load favorites', e.message);
  console.warn("Failed to load favorites:", e);
  favs = [];
  localStorage.removeItem("ads_favorites"); // Clear corrupted data
}

debugLog('element', 'Getting DOM elements...');
const grid = document.getElementById("ads-grid");
const loadingEl = document.getElementById("loading");
const noResultsEl = document.getElementById("no-results");

debugLog('element', 'DOM elements status', {
  grid: grid ? '‚úÖ Found' : '‚ùå Missing',
  loadingEl: loadingEl ? '‚úÖ Found' : '‚ùå Missing',
  noResultsEl: noResultsEl ? '‚úÖ Found' : '‚ùå Missing'
});

// Store active contact info
let activeContact = {};

// ==============================
// DEVICE FINGERPRINTING & AI
// ==============================
let userProfile = null;
let deviceReady = false;
let personalizedAds = [];

// ==============================
// VOICE SEARCH
// ==============================
let recognition = null;
let isVoiceSearching = false;

function initVoiceSearch() {
  // Check if browser supports speech recognition
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    console.warn('Voice search not supported in this browser');
    document.getElementById('voiceSearchBtn')?.classList.add('hidden');
    return;
  }

  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'en-US';

  recognition.onstart = () => {
    isVoiceSearching = true;
    const btn = document.getElementById('voiceSearchBtn');
    const status = document.getElementById('voiceStatus');
    const statusText = document.getElementById('voiceStatusText');

    btn.classList.add('animate-pulse', 'bg-red-600');
    btn.classList.remove('bg-indigo-600');
    status.classList.remove('hidden');
    statusText.textContent = 'Listening... Speak now';
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    const searchInput = document.getElementById('search');

    // Set the transcribed text to search box
    searchInput.value = transcript;

    // Show feedback
    const statusText = document.getElementById('voiceStatusText');
    statusText.textContent = `Heard: "${transcript}"`;

    // Auto-trigger search after 1 second
    setTimeout(() => {
      document.getElementById('btnSearch').click();
    }, 1000);
  };

  recognition.onerror = (event) => {
    console.error('Voice search error:', event.error);
    const statusText = document.getElementById('voiceStatusText');

    if (event.error === 'no-speech') {
      statusText.textContent = 'No speech detected. Try again.';
    } else if (event.error === 'not-allowed') {
      statusText.textContent = 'Microphone access denied.';
    } else {
      statusText.textContent = 'Error: ' + event.error;
    }

    setTimeout(() => {
      document.getElementById('voiceStatus').classList.add('hidden');
    }, 3000);
  };

  recognition.onend = () => {
    isVoiceSearching = false;
    const btn = document.getElementById('voiceSearchBtn');
    btn.classList.remove('animate-pulse', 'bg-red-600');
    btn.classList.add('bg-indigo-600');

    setTimeout(() => {
      document.getElementById('voiceStatus').classList.add('hidden');
    }, 2000);
  };
}

// Initialize voice search on page load
initVoiceSearch();

// Voice search button click handler
document.getElementById('voiceSearchBtn')?.addEventListener('click', () => {
  if (!recognition) {
    alert('Voice search is not supported in your browser. Please use Chrome, Edge, or Safari.');
    return;
  }

  if (isVoiceSearching) {
    recognition.stop();
  } else {
    recognition.start();
  }
});

// Rate limiting for contact actions
const contactAttempts = new Map();
const RATE_LIMIT_WINDOW = 60000; // 1 minute
const MAX_ATTEMPTS = 3;

function checkRateLimit(action) {
  const now = Date.now();
  const key = `${action}-${activeContact.phone || activeContact.email}`;

  if (!contactAttempts.has(key)) {
    contactAttempts.set(key, []);
  }

  const attempts = contactAttempts.get(key);
  const recentAttempts = attempts.filter(time => now - time < RATE_LIMIT_WINDOW);

  if (recentAttempts.length >= MAX_ATTEMPTS) {
    alert("Too many attempts. Please wait a minute before trying again.");
    return false;
  }

  recentAttempts.push(now);
  contactAttempts.set(key, recentAttempts);
  return true;
}

// ==============================
// FAVORITES
// ==============================
async function toggleFav(id) {
  id = String(id);

  const isCurrentlyFavorited = favs.includes(id);
  const action = isCurrentlyFavorited ? 'unfavorite' : 'favorite';

  if (isCurrentlyFavorited) {
    favs = favs.filter(f => f !== id);
  } else {
    favs.push(id);
  }

  localStorage.setItem("ads_favorites", JSON.stringify(favs));

  // Track favorite interaction with analytics API
  try {
    await fetch('/app/api/track_interaction.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        interaction_type: action === 'favorite' ? 'favorite' : 'unfavorite',
        ad_id: id
      })
    });
  } catch (e) {
    console.error('Failed to track favorite:', e);
  }

  // Track with device fingerprinting (AI learning)
  if (window.deviceFingerprint && deviceReady) {
    try {
      // Favorites are treated as strong positive signals
      if (action === 'favorite') {
        await window.deviceFingerprint.trackInteraction(id, 'favorite');

        // Track category preference
        const card = document.querySelector(`[data-fav="${id}"]`)?.closest('.break-inside-avoid');
        const category = card?.dataset.category;
        if (category) {
          await window.deviceFingerprint.trackCategoryInteraction(category, true);
        }
      }
    } catch (e) {
      console.error('Failed to track AI learning for favorite:', e);
    }
  }
}

// ==============================
// FEED RESET
// ==============================
function resetFeed() {
  page = 1;
  finished = false;
  grid.innerHTML = "";
  noResultsEl.classList.add("hidden");
}

// ==============================
// LOAD CATEGORIES
// ==============================
async function loadCategories() {
  debugLog('api', 'Loading categories from API...');

  try {
    const res = await fetch("/app/api/get_categories.php");
    debugLog('response', `Categories API responded: ${res.status}`);

    const data = await res.json();
    debugLog('response', 'Categories data received', {
      hasCategories: !!data.categories,
      count: data.categories?.length || 0
    });

    const select = document.getElementById("categoryFilter");
    if (!select) {
      debugLog('error', 'Category filter element not found!');
      return;
    }

    select.innerHTML = '<option value="">All Categories</option>';

    // Handle new database format (objects with slug and name)
    if (data.categories && Array.isArray(data.categories)) {
      debugLog('info', `Adding ${data.categories.length} categories to dropdown`);

      data.categories.forEach(cat => {
        const opt = document.createElement("option");
        // Check if it's an object (new format) or string (old format)
        if (typeof cat === 'object' && cat.slug) {
          opt.value = cat.slug;
          opt.textContent = `${cat.name} (${cat.ad_count || 0})`;
        } else {
          // Fallback for old format
          opt.value = cat;
          opt.textContent = cat;
        }
        select.appendChild(opt);
      });

      debugLog('success', 'Categories loaded successfully');
    }
  } catch (e) {
    debugLog('error', 'Failed to load categories', e.message);
    console.warn("loadCategories error", e);
  }
}

// ==============================
// INITIALIZE DEVICE INTELLIGENCE
// ==============================
async function initializeDeviceIntelligence() {
  if (deviceReady) return;

  try {
    // Initialize device fingerprint
    userProfile = await window.deviceFingerprint.init();
    deviceReady = true;

    console.log('üß† AI Intelligence Active');
    console.log('Profile Strength:', userProfile ?
      (userProfile.behavior.total_interactions < 5 ? 'Learning...' :
       userProfile.behavior.total_interactions < 20 ? 'Building...' : 'Strong') :
      'New');

    // Get personalized recommendations
    if (userProfile && userProfile.behavior.total_interactions > 3) {
      const recommendations = await window.deviceFingerprint.getRecommendations();
      if (recommendations && recommendations.length > 0) {
        personalizedAds = recommendations.map(r => r.ad);
        console.log(`üìä Personalized: ${personalizedAds.length} ads ranked by relevance`);
      }
    }
  } catch (e) {
    console.warn('Device intelligence initialization failed:', e);
    deviceReady = false;
  }
}

// ==============================
// LOAD ADS (INTELLIGENT)
// ==============================
async function loadAds(reset = false) {
  debugLog('api', `loadAds() called`, { reset, page, loading, finished });

  if (reset) {
    debugLog('info', 'Resetting feed...');
    resetFeed();
  }

  if (loading || finished) {
    debugLog('warning', 'Skipping load', { loading, finished });
    return;
  }

  loading = true;
  loadingEl.classList.remove("hidden");
  debugLog('info', 'Loading state activated');

  try {
    // Initialize device intelligence on first load
    if (!deviceReady) {
      debugLog('info', 'Initializing device intelligence...');
      await initializeDeviceIntelligence();
    }

    // Get ads from API
    const apiUrl = `/app/api/get_ads.php?page=${page}&q=${encodeURIComponent(q)}&category=${encodeURIComponent(category)}&sort=${encodeURIComponent(sort)}`;
    debugLog('api', 'Fetching ads from API', { url: apiUrl });

    const res = await fetch(apiUrl);

    debugLog('response', `API responded with status: ${res.status} ${res.statusText}`);

    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }

    const data = await res.json();
    debugLog('response', 'API response received', {
      success: data.success,
      adsCount: data.ads?.length || 0,
      page: data.page,
      total: data.total
    });

    console.log('üì¶ Full API Response:', data);

    if (!data.ads || !data.ads.length) {
      finished = true;
      debugLog('warning', 'No ads found in API response');

      if (page === 1) {
        debugLog('info', 'Showing "no results" message');
        noResultsEl.classList.remove("hidden");
      }
    } else {
      let adsToRender = data.ads;
      debugLog('data', `Processing ${adsToRender.length} ads`);

      // INTELLIGENT SORTING: Use personalized recommendations if available
      if (personalizedAds.length > 0 && !q && !category && sort === 'date') {
        debugLog('info', 'Applying AI personalization...');
        adsToRender = sortAdsByPersonalization(data.ads);

        // Show intelligence indicator
        if (page === 1) {
          showIntelligenceIndicator();
        }
      }

      debugLog('render', `Calling renderAds() with ${adsToRender.length} ads`);
      renderAds(adsToRender);
      page++;
      debugLog('success', `Successfully loaded page ${page - 1}`);
    }
  } catch (e) {
    finished = true;
    debugLog('error', 'Failed to load ads', e.message);
    console.error("‚ùå loadAds error:", e);
    console.error("Error details:", e.message);
    console.error("Stack:", e.stack);

    // Show error to user
    if (page === 1) {
      noResultsEl.textContent = 'Failed to load ads. Please refresh the page.';
      noResultsEl.classList.remove("hidden");
      debugLog('error', 'Showing error message to user');
    }
  }

  loading = false;
  loadingEl.classList.add("hidden");
  debugLog('info', 'Loading state deactivated');
}

// ==============================
// INTELLIGENT AD SORTING
// ==============================
function sortAdsByPersonalization(ads) {
  if (!personalizedAds.length) return ads;

  // Create a map of personalized ad IDs with their scores
  const scoreMap = new Map();
  personalizedAds.forEach((ad, index) => {
    scoreMap.set(ad.ad_id, 1000 - index); // Higher score for higher ranked ads
  });

  // Sort ads by personalization score
  return ads.sort((a, b) => {
    const scoreA = scoreMap.get(a.ad_id) || 0;
    const scoreB = scoreMap.get(b.ad_id) || 0;
    return scoreB - scoreA;
  });
}

// ==============================
// SHOW INTELLIGENCE INDICATOR
// ==============================
function showIntelligenceIndicator() {
  const indicator = document.createElement('div');
  indicator.className = 'fixed top-20 right-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-pulse';
  indicator.innerHTML = `
    <div class="flex items-center gap-2">
      <i class="fas fa-brain"></i>
      <span class="text-sm font-semibold">AI Personalized</span>
    </div>
  `;
  document.body.appendChild(indicator);

  // Remove after 3 seconds
  setTimeout(() => {
    indicator.style.opacity = '0';
    indicator.style.transition = 'opacity 0.5s';
    setTimeout(() => indicator.remove(), 500);
  }, 3000);
}

// ==============================
// SECURITY: HTML SANITIZATION
// ==============================
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ==============================
// RENDER ADS
// ==============================
function renderAds(ads) {
  debugLog('render', `renderAds() called with ${ads.length} ads`);

  if (!grid) {
    debugLog('error', 'Grid element is NULL! Cannot render ads.');
    console.error('‚ùå Grid element not found!');
    return;
  }

  debugLog('info', `Grid element found, current children: ${grid.children.length}`);

  let renderedCount = 0;
  let errorCount = 0;

  ads.forEach((ad, index) => {
    try {
      const id = String(ad.ad_id || ad.id || Math.random());
      debugLog('render', `[${index + 1}/${ads.length}] Rendering ad: ${id}`, {
        title: ad.title,
        category: ad.category,
        hasMedia: !!ad.media
      });

      // Track view (only once per ad per session)
      trackAdView(id);

    // Create card container
    const card = document.createElement("div");
    card.className = "break-inside-avoid bg-white/10 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition hover:-translate-y-1";

    // Store contact data and ad info in dataset
    card.dataset.contact = JSON.stringify(ad.contact || {});
    card.dataset.adTitle = ad.title || 'Untitled';
    card.dataset.adDescription = ad.description || '';
    card.dataset.adId = id;
    card.dataset.category = ad.category || 'uncategorized';

    // Sanitize user inputs
    const safeTitle = escapeHtml(ad.title || 'Untitled');
    const safeCategory = escapeHtml(ad.category || '');
    const safeMedia = escapeHtml(ad.media || '');

    // Create media container
    const mediaContainer = document.createElement('div');
    mediaContainer.className = 'relative h-64 overflow-hidden';

    // Create favorite button
    const favBtn = document.createElement('button');
    favBtn.setAttribute('data-fav', id);
    favBtn.className = `absolute top-2 right-2 w-9 h-9 rounded-full flex items-center justify-center text-white text-xl ${favs.includes(id) ? 'bg-red-600' : 'bg-black/60'}`;
    favBtn.textContent = '‚ù§Ô∏è';
    mediaContainer.appendChild(favBtn);

    // Create media element
    const isVideo = ad.media && /\.(mp4|mov|webm)$/i.test(ad.media);
    if (isVideo) {
      const video = document.createElement('video');
      video.autoplay = true;
      video.muted = true;
      video.loop = true;
      video.playsInline = true;
      video.className = 'w-full h-full object-cover';

      const source = document.createElement('source');
      source.src = safeMedia;
      video.appendChild(source);

      mediaContainer.appendChild(video);
    } else {
      const img = document.createElement('img');
      img.src = safeMedia;
      img.alt = safeTitle;
      img.className = 'w-full h-full object-cover';
      mediaContainer.appendChild(img);
    }

    // Create category badge
    const categoryBadge = document.createElement('div');
    categoryBadge.className = 'absolute bottom-2 left-2 bg-black/60 px-2 rounded text-xs';
    categoryBadge.textContent = safeCategory;
    mediaContainer.appendChild(categoryBadge);

    // Create content section
    const contentDiv = document.createElement('div');
    contentDiv.className = 'p-3';

    // Create title
    const titleDiv = document.createElement('div');
    titleDiv.className = 'font-bold truncate';
    titleDiv.textContent = safeTitle;
    contentDiv.appendChild(titleDiv);

    // Create button container
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'mt-3 flex gap-2';

    // Create contact button (NO ID to avoid duplicates)
    const contactBtn = document.createElement('button');
    contactBtn.className = 'contact-dealer flex-1 bg-indigo-600 hover:bg-indigo-700 py-2 rounded text-sm';
    contactBtn.textContent = 'Contact Dealer';
    buttonContainer.appendChild(contactBtn);

    // Create more button
    const moreBtn = document.createElement('button');
    moreBtn.className = 'more-dealer flex-1 bg-gray-700 hover:bg-gray-800 py-2 rounded text-sm';
    moreBtn.textContent = 'More from them';
    buttonContainer.appendChild(moreBtn);

    contentDiv.appendChild(buttonContainer);

    // Create interaction buttons container (Like/Not Interested)
    const interactionContainer = document.createElement('div');
    interactionContainer.className = 'mt-2 flex gap-2';

    // Check if user already liked/disliked this ad
    const likedAds = getLikedAds();
    const dislikedAds = getDislikedAds();
    const isLiked = likedAds.includes(id);
    const isDisliked = dislikedAds.includes(id);

    // Create Like button
    const likeBtn = document.createElement('button');
    likeBtn.setAttribute('data-like', id);
    likeBtn.className = `like-btn flex-1 py-2 rounded text-sm transition-all ${
      isLiked
        ? 'bg-green-600 text-white'
        : 'bg-white/10 hover:bg-green-600/20 border border-white/20'
    }`;
    likeBtn.innerHTML = `<i class="fas fa-thumbs-up mr-1"></i>${isLiked ? 'Liked' : 'Like'}`;
    interactionContainer.appendChild(likeBtn);

    // Create Not Interested button
    const dislikeBtn = document.createElement('button');
    dislikeBtn.setAttribute('data-dislike', id);
    dislikeBtn.className = `dislike-btn flex-1 py-2 rounded text-sm transition-all ${
      isDisliked
        ? 'bg-red-600 text-white'
        : 'bg-white/10 hover:bg-red-600/20 border border-white/20'
    }`;
    dislikeBtn.innerHTML = `<i class="fas fa-thumbs-down mr-1"></i>${isDisliked ? 'Not Interested' : 'Not Interested'}`;
    interactionContainer.appendChild(dislikeBtn);

    contentDiv.appendChild(interactionContainer);

    // Assemble card
    card.appendChild(mediaContainer);
    card.appendChild(contentDiv);
    grid.appendChild(card);

    renderedCount++;
    debugLog('success', `Ad ${id} successfully added to grid`);

    // Start tracking time for this ad
    startTrackingTime(id);

    } catch (error) {
      errorCount++;
      debugLog('error', `Failed to render ad at index ${index}`, error.message);
      console.error('Render error for ad:', ad, error);
    }
  });

  debugLog('render', `Rendering complete!`, {
    total: ads.length,
    rendered: renderedCount,
    errors: errorCount,
    gridChildCount: grid.children.length
  });

  if (renderedCount > 0) {
    debugLog('success', `‚ú® ${renderedCount} ads are now visible in the grid!`);
  } else {
    debugLog('error', 'No ads were rendered! Check errors above.');
  }
}

// ==============================
// EVENTS
// ==============================
grid.addEventListener("click", e => {
  const favBtn = e.target.closest("[data-fav]");
  if (favBtn) {
    toggleFav(favBtn.dataset.fav);
    favBtn.classList.toggle("bg-red-600");
    favBtn.classList.toggle("bg-black/60");
    return;
  }

  // Handle Like button
  const likeBtn = e.target.closest("[data-like]");
  if (likeBtn) {
    const adId = likeBtn.dataset.like;
    handleLike(adId, likeBtn);
    return;
  }

  // Handle Dislike button
  const dislikeBtn = e.target.closest("[data-dislike]");
  if (dislikeBtn) {
    const adId = dislikeBtn.dataset.dislike;
    handleDislike(adId, dislikeBtn);
    return;
  }

  const contactBtn = e.target.closest(".contact-dealer");
  if (contactBtn) {
    const card = contactBtn.closest(".break-inside-avoid");
    let contact = {};
    try {
      contact = JSON.parse(card.dataset.contact || "{}");
    } catch (e) {
      console.error("Failed to parse contact data:", e);
      alert("Error loading contact information.");
      return;
    }

    // Extract ad info for auto-fill
    const adTitle = card.dataset.adTitle || '';
    const adDescription = card.dataset.adDescription || '';
    const adId = card.dataset.adId || '';

    // Add ad ID to contact object
    contact.adId = adId;

    openDealerModal(contact, adTitle, adDescription);
    return;
  }

});

// Search & filters
document.getElementById("btnSearch").onclick = () => {
  q = document.getElementById("search").value.trim();
  loadAds(true);
};

document.getElementById("categoryFilter").onchange = e => {
  category = e.target.value;
  loadAds(true);
};

document.getElementById("sortFilter").onchange = e => {
  sort = e.target.value;
  loadAds(true);
};

let debounce;
document.getElementById("search").oninput = e => {
  clearTimeout(debounce);
  debounce = setTimeout(() => {
    q = e.target.value.trim();
    loadAds(true);
  }, 350);
};

// Infinite scroll
window.addEventListener("scroll", () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 450) {
    loadAds();
  }
});

// ==============================
// MODAL FUNCTIONS
// ==============================
function openDealerModal(contact = {}, adTitle = '', adDescription = '') {
  const modal = document.getElementById("contactDealerModal");
  const modalCard = document.getElementById("contactDealerCard");
  const messageBox = document.getElementById("contactDealerMessage");
  const charCount = document.getElementById("charCount");
  const senderName = document.getElementById("senderName");
  const senderContact = document.getElementById("senderContact");

  // Store contact data
  activeContact = contact;

  // Clear sender info fields
  senderName.value = "";
  senderContact.value = "";

  // Auto-fill message with ad details
  let autoMessage = "Hi, I'm interested in your ad";

  if (adTitle) {
    autoMessage += ` titled "${adTitle}"`;
  }

  if (adDescription) {
    autoMessage += `.\n\nDescription: ${adDescription}`;
  }

  autoMessage += ".\n\nCan I get more info on this?\n\nThank you.";

  // Ensure message doesn't exceed 500 characters
  if (autoMessage.length > 500) {
    // Truncate description if too long
    const maxDescLength = 500 - autoMessage.length + adDescription.length - 3;
    if (maxDescLength > 0) {
      const truncatedDesc = adDescription.substring(0, maxDescLength) + '...';
      autoMessage = "Hi, I'm interested in your ad";
      if (adTitle) {
        autoMessage += ` titled "${adTitle}"`;
      }
      autoMessage += `.\n\nDescription: ${truncatedDesc}`;
      autoMessage += ".\n\nCan I get more info on this?\n\nThank you.";
    } else {
      // If still too long, just use title
      autoMessage = `Hi, I'm interested in your ad "${adTitle}".\n\nCan I get more info on this?\n\nThank you.`;
    }
  }

  messageBox.value = autoMessage;
  if (charCount) charCount.textContent = autoMessage.length;

  // Show modal
  modal.classList.remove("hidden");
  modal.classList.add("flex", "items-center", "justify-center");

  // Animate modal card in
  setTimeout(() => {
    modalCard.classList.remove("scale-95", "opacity-0");
    modalCard.classList.add("scale-100", "opacity-100");
    messageBox.focus();
    // Move cursor to end of text
    messageBox.setSelectionRange(messageBox.value.length, messageBox.value.length);
  }, 10);
}

// Character counter for message textarea
const messageBox = document.getElementById("contactDealerMessage");
const charCount = document.getElementById("charCount");
if (messageBox && charCount) {
  messageBox.addEventListener("input", () => {
    charCount.textContent = messageBox.value.length;
  });
}

function closeDealerModal() {
  const modal = document.getElementById("contactDealerModal");
  const modalCard = document.getElementById("contactDealerCard");

  // Animate modal card out
  modalCard.classList.remove("scale-100", "opacity-100");
  modalCard.classList.add("scale-95", "opacity-0");

  // Hide modal after animation
  setTimeout(() => {
    modal.classList.remove("flex", "items-center", "justify-center");
    modal.classList.add("hidden");
  }, 200);
}

// Close modal when clicking outside (backdrop)
document.getElementById("contactDealerModal").addEventListener("click", (e) => {
  if (e.target.id === "contactDealerModal") {
    closeDealerModal();
  }
});

// Close modal with X button
document.getElementById("closeDealerModalBtn").addEventListener("click", closeDealerModal);

// ==============================
// CONTACT ACTIONS
// ==============================
// Build final message with sender info
function buildFinalMessage(message) {
  const senderName = document.getElementById("senderName").value.trim();
  const senderContact = document.getElementById("senderContact").value.trim();

  let finalMessage = message;

  if (senderName || senderContact) {
    finalMessage += "\n\n---\n";
    if (senderName) {
      finalMessage += `From: ${senderName}\n`;
    }
    if (senderContact) {
      finalMessage += `Contact: ${senderContact}\n`;
    }
  } else {
    finalMessage += "\n\n---\n";
  }

  // Add timestamp
  const now = new Date();
  const dateStr = now.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  const timeStr = now.toLocaleTimeString('en-US', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });

  finalMessage += `Sent on: ${dateStr} at: ${timeStr}`;

  return finalMessage;
}

// Input validation functions
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(String(email).toLowerCase());
}

function validatePhone(phone) {
  const cleaned = String(phone).replace(/\D/g, '');
  return cleaned.length >= 9 && cleaned.length <= 15;
}

function sanitizeMessage(msg) {
  if (!msg) return '';
  // Limit message length
  let sanitized = String(msg).trim();
  if (sanitized.length > 500) {
    sanitized = sanitized.substring(0, 500);
  }
  // Remove potentially dangerous characters
  sanitized = sanitized.replace(/[<>]/g, '');
  return sanitized;
}

// Normalize phone number to international format
function normalizePhone(phone) {
  if (!phone) return "";
  let num = String(phone).replace(/\D/g, "");
  if (num.startsWith("0")) num = "254" + num.slice(1);
  if (!num.startsWith("254")) num = "254" + num;
  return num;
}

// Call button handler
document.getElementById("callDealerNow").addEventListener("click", () => {
  if (!checkRateLimit('call')) return;

  const phone = activeContact.phone;

  if (!phone) {
    alert("No phone number available for this seller.");
    return;
  }

  if (!validatePhone(phone)) {
    alert("Invalid phone number format.");
    return;
  }

  // Track contact event
  if (activeContact.adId) {
    trackContact(activeContact.adId, 'call');
  }

  const normalizedPhone = normalizePhone(phone);
  window.location.href = `tel:+${normalizedPhone}`;
});

// WhatsApp button handler
document.getElementById("sendDealerWhatsApp").addEventListener("click", () => {
  if (!checkRateLimit('whatsapp')) return;

  const phone = activeContact.phone;
  const rawMessage = document.getElementById("contactDealerMessage").value;

  if (!phone) {
    alert("No phone number available for this seller.");
    return;
  }

  if (!validatePhone(phone)) {
    alert("Invalid phone number format.");
    return;
  }

  const message = sanitizeMessage(rawMessage);
  if (!message) {
    alert("Please type a message first!");
    return;
  }

  // Build final message with sender info
  const finalMessage = buildFinalMessage(message);

  // Track contact event
  if (activeContact.adId) {
    trackContact(activeContact.adId, 'whatsapp');
  }

  const normalizedPhone = normalizePhone(phone);
  const encodedMessage = encodeURIComponent(finalMessage);
  window.open(`https://wa.me/${normalizedPhone}?text=${encodedMessage}`, "_blank");
});

// SMS button handler
document.getElementById("sendDealerSMS").addEventListener("click", () => {
  if (!checkRateLimit('sms')) return;

  const phone = activeContact.phone;
  const rawMessage = document.getElementById("contactDealerMessage").value;

  if (!phone) {
    alert("No phone number available for this seller.");
    return;
  }

  if (!validatePhone(phone)) {
    alert("Invalid phone number format.");
    return;
  }

  const message = sanitizeMessage(rawMessage);
  if (!message) {
    alert("Please type a message first!");
    return;
  }

  // Build final message with sender info
  const finalMessage = buildFinalMessage(message);

  // Track contact event
  trackContact(activeContact.adId, 'sms');

  const normalizedPhone = normalizePhone(phone);
  const encodedMessage = encodeURIComponent(finalMessage);
  window.location.href = `sms:+${normalizedPhone}?body=${encodedMessage}`;
});

// Email button handler
document.getElementById("sendDealerEmail").addEventListener("click", () => {
  if (!checkRateLimit('email')) return;

  const email = activeContact.email;
  const rawMessage = document.getElementById("contactDealerMessage").value;

  if (!email) {
    alert("No email address available for this seller.");
    return;
  }

  if (!validateEmail(email)) {
    alert("Invalid email address format.");
    return;
  }

  const message = sanitizeMessage(rawMessage);
  if (!message) {
    alert("Please type a message first!");
    return;
  }

  // Build final message with sender info
  const finalMessage = buildFinalMessage(message);

  // Track contact event
  if (activeContact.adId) {
    trackContact(activeContact.adId, 'email');
  }

  const encodedMessage = encodeURIComponent(finalMessage);
  const subject = encodeURIComponent("Inquiry about your ad");
  window.location.href = `mailto:${email}?subject=${subject}&body=${encodedMessage}`;
});

// ==============================
// LIKE/DISLIKE TRACKING
// ==============================
function getLikedAds() {
  try {
    const stored = localStorage.getItem("ads_liked");
    if (stored) {
      const parsed = JSON.parse(stored);
      if (Array.isArray(parsed)) {
        return parsed.slice(0, 1000); // Limit to prevent abuse
      }
    }
  } catch (e) {
    console.warn("Failed to load liked ads:", e);
  }
  return [];
}

function getDislikedAds() {
  try {
    const stored = localStorage.getItem("ads_disliked");
    if (stored) {
      const parsed = JSON.parse(stored);
      if (Array.isArray(parsed)) {
        return parsed.slice(0, 1000);
      }
    }
  } catch (e) {
    console.warn("Failed to load disliked ads:", e);
  }
  return [];
}

function saveLikedAds(likedAds) {
  try {
    localStorage.setItem("ads_liked", JSON.stringify(likedAds));
  } catch (e) {
    console.warn("Failed to save liked ads:", e);
  }
}

function saveDislikedAds(dislikedAds) {
  try {
    localStorage.setItem("ads_disliked", JSON.stringify(dislikedAds));
  } catch (e) {
    console.warn("Failed to save disliked ads:", e);
  }
}

async function handleLike(adId, button) {
  const likedAds = getLikedAds();
  const dislikedAds = getDislikedAds();

  // Check if already liked
  if (likedAds.includes(adId)) {
    // Unlike
    const newLiked = likedAds.filter(id => id !== adId);
    saveLikedAds(newLiked);

    // Update button UI
    button.classList.remove('bg-green-600', 'text-white');
    button.classList.add('bg-white/10');
    button.innerHTML = '<i class="fas fa-thumbs-up mr-1"></i>Like';
    return;
  }

  // Remove from disliked if exists
  if (dislikedAds.includes(adId)) {
    const newDisliked = dislikedAds.filter(id => id !== adId);
    saveDislikedAds(newDisliked);

    // Update dislike button if visible
    const dislikeBtn = document.querySelector(`[data-dislike="${adId}"]`);
    if (dislikeBtn) {
      dislikeBtn.classList.remove('bg-red-600', 'text-white');
      dislikeBtn.classList.add('bg-white/10');
      dislikeBtn.innerHTML = '<i class="fas fa-thumbs-down mr-1"></i>Not Interested';
    }
  }

  // Add to liked
  likedAds.push(adId);
  saveLikedAds(likedAds);

  // Update button UI
  button.classList.remove('bg-white/10');
  button.classList.add('bg-green-600', 'text-white');
  button.innerHTML = '<i class="fas fa-thumbs-up mr-1"></i>Liked';

  // Track interaction (standard)
  try {
    await fetch('/app/api/track_interaction.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        interaction_type: 'like',
        ad_id: adId
      })
    });
  } catch (e) {
    console.error('Failed to track like:', e);
  }

  // Track with device fingerprinting (AI learning)
  if (window.deviceFingerprint && deviceReady) {
    try {
      await window.deviceFingerprint.trackInteraction(adId, 'like');

      // Find ad category and track it
      const card = button.closest('.break-inside-avoid');
      const category = card.dataset.category;
      if (category) {
        await window.deviceFingerprint.trackCategoryInteraction(category, true);
      }
    } catch (e) {
      console.error('Failed to track AI learning:', e);
    }
  }
}

async function handleDislike(adId, button) {
  const likedAds = getLikedAds();
  const dislikedAds = getDislikedAds();

  // Check if already disliked
  if (dislikedAds.includes(adId)) {
    // Un-dislike
    const newDisliked = dislikedAds.filter(id => id !== adId);
    saveDislikedAds(newDisliked);

    // Update button UI
    button.classList.remove('bg-red-600', 'text-white');
    button.classList.add('bg-white/10');
    button.innerHTML = '<i class="fas fa-thumbs-down mr-1"></i>Not Interested';
    return;
  }

  // Remove from liked if exists
  if (likedAds.includes(adId)) {
    const newLiked = likedAds.filter(id => id !== adId);
    saveLikedAds(newLiked);

    // Update like button if visible
    const likeBtn = document.querySelector(`[data-like="${adId}"]`);
    if (likeBtn) {
      likeBtn.classList.remove('bg-green-600', 'text-white');
      likeBtn.classList.add('bg-white/10');
      likeBtn.innerHTML = '<i class="fas fa-thumbs-up mr-1"></i>Like';
    }
  }

  // Add to disliked
  dislikedAds.push(adId);
  saveDislikedAds(dislikedAds);

  // Update button UI
  button.classList.remove('bg-white/10');
  button.classList.add('bg-red-600', 'text-white');
  button.innerHTML = '<i class="fas fa-thumbs-down mr-1"></i>Not Interested';

  // Track interaction
  try {
    await fetch('/app/api/track_interaction.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        interaction_type: 'dislike',
        ad_id: adId
      })
    });
  } catch (e) {
    console.error('Failed to track dislike:', e);
  }

  // Track with device fingerprinting (AI learning)
  if (window.deviceFingerprint && deviceReady) {
    try {
      await window.deviceFingerprint.trackInteraction(adId, 'dislike');

      // Find ad category and track negative preference
      const card = button.closest('.break-inside-avoid');
      const category = card.dataset.category;
      if (category) {
        await window.deviceFingerprint.trackCategoryInteraction(category, false);
      }
    } catch (e) {
      console.error('Failed to track AI learning:', e);
    }
  }
}

// ==============================
// TIME TRACKING
// ==============================
const adTimeTracking = new Map();

function startTrackingTime(adId) {
  if (!adTimeTracking.has(adId)) {
    adTimeTracking.set(adId, {
      startTime: Date.now(),
      reported: false
    });
  }
}

function stopTrackingTime(adId) {
  if (adTimeTracking.has(adId)) {
    const tracking = adTimeTracking.get(adId);
    if (!tracking.reported) {
      const timeSpent = Math.floor((Date.now() - tracking.startTime) / 1000); // Convert to seconds

      // Only report if user spent at least 3 seconds viewing
      if (timeSpent >= 3) {
        trackTimeSpent(adId, timeSpent);
      }

      tracking.reported = true;
    }
  }
}

async function trackTimeSpent(adId, seconds) {
  try {
    await fetch('/app/api/track_interaction.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        interaction_type: 'time_spent',
        ad_id: adId,
        value: seconds
      })
    });
  } catch (e) {
    console.error('Failed to track time:', e);
  }
}

// Track time when user leaves page or scrolls away
window.addEventListener('beforeunload', () => {
  adTimeTracking.forEach((tracking, adId) => {
    stopTrackingTime(adId);
  });
});

// Track time periodically for ads in viewport
let lastScrollTime = Date.now();
window.addEventListener('scroll', () => {
  const now = Date.now();

  // Only check every 2 seconds to avoid performance issues
  if (now - lastScrollTime < 2000) return;
  lastScrollTime = now;

  // Check which ads are in viewport and report time for those that scrolled away
  const cards = document.querySelectorAll('.break-inside-avoid');
  cards.forEach(card => {
    const adId = card.dataset.adId;
    if (!adId) return;

    const rect = card.getBoundingClientRect();
    const isInViewport = rect.top < window.innerHeight && rect.bottom > 0;

    if (!isInViewport && adTimeTracking.has(adId)) {
      stopTrackingTime(adId);
    }
  });
});

// ==============================
// ANALYTICS TRACKING
// ==============================
const viewedAds = new Set();

async function trackAdView(adId) {
  // Only track once per session
  if (viewedAds.has(adId)) return;
  viewedAds.add(adId);

  try {
    await fetch('/app/api/track_event.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        event_type: 'view',
        ad_id: adId,
        metadata: {
          referrer: document.referrer,
          page: window.location.pathname
        }
      })
    });
  } catch (e) {
    console.error('Failed to track view:', e);
  }
}

async function trackContact(adId, method) {
  try {
    await fetch('/app/api/track_event.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        event_type: 'contact',
        ad_id: adId,
        metadata: {
          method: method,
          timestamp: Date.now()
        }
      })
    });
  } catch (e) {
    console.error('Failed to track contact:', e);
  }
}

// ==============================
// INIT
// ==============================
function initializeAdPage() {
  debugLog('init', '========================================');
  debugLog('init', 'INITIALIZING AD PAGE');
  debugLog('init', '========================================');

  // Verify required elements exist
  const requiredElements = {
    'ads-grid': grid,
    'loading': loadingEl,
    'no-results': noResultsEl,
    'search': document.getElementById('search'),
    'categoryFilter': document.getElementById('categoryFilter'),
    'sortFilter': document.getElementById('sortFilter'),
    'btnSearch': document.getElementById('btnSearch'),
    'voiceSearchBtn': document.getElementById('voiceSearchBtn'),
    'contactDealerModal': document.getElementById('contactDealerModal')
  };

  let missingElements = [];
  let foundElements = [];

  for (const [name, element] of Object.entries(requiredElements)) {
    if (!element) {
      missingElements.push(name);
      debugLog('error', `Missing element: ${name}`);
    } else {
      foundElements.push(name);
      debugLog('element', `Found element: ${name}`);
    }
  }

  debugLog('element', `Element check summary`, {
    total: Object.keys(requiredElements).length,
    found: foundElements.length,
    missing: missingElements.length
  });

  if (missingElements.length > 0) {
    debugLog('error', '‚ùå INITIALIZATION FAILED', { missingElements });
    console.error('‚ùå Cannot initialize - missing elements:', missingElements);
    alert('Page loading error. Please refresh the page.\n\nMissing elements: ' + missingElements.join(', '));
  } else {
    debugLog('success', '‚úÖ ALL REQUIRED ELEMENTS FOUND');
    debugLog('init', 'Loading categories...');
    loadCategories();

    debugLog('init', 'Starting initial ad load...');
    loadAds();

    debugLog('init', '========================================');
    debugLog('init', 'INITIALIZATION COMPLETE - Watch for API calls');
    debugLog('init', '========================================');
  }
}

// Run initialization when DOM is ready
if (document.readyState === 'loading') {
  debugLog('init', 'DOM is still loading, waiting for DOMContentLoaded...');
  document.addEventListener('DOMContentLoaded', () => {
    debugLog('init', 'DOMContentLoaded event fired');
    initializeAdPage();
  });
} else {
  debugLog('init', 'DOM is already ready, initializing immediately');
  initializeAdPage();
}

    </script> <!-- ============================================ --> <!-- FOOTER --> <!-- ============================================ --> <footer class="w-full bg-black/20 backdrop-blur-md shadow-inner text-white mt-20 py-10"> <div class="max-w-sm mx-auto flex flex-col items-center text-center gap-6 px-4"> <h2 class="text-lg font-semibold bg-clip-text text-transparent bg-gradient-to-r from-indigo-300 via-pink-400 to-purple-400"> The future of digital advertising </h2> <div class="border-t border-white/20 w-full pt-4 text-xs text-white/70"> &copy; <span id="footer-year"></span> AdSphere. All rights reserved. </div> </div> </footer> <!-- ============================================ --> <!-- SCRIPTS --> <!-- ============================================ --> <script>
// Mobile menu toggle
const mobileBtn = document.getElementById('mobile-menu-button');
const mobileMenu = document.getElementById('mobile-menu');
if (mobileBtn && mobileMenu) {
    mobileBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
}

// Smooth scrolling for navigation links
document.querySelectorAll('a.nav-link, a.mobile-link, a[href^="#"]').forEach(link => {
    link.addEventListener('click', e => {
        const href = link.getAttribute('href');
        if (href.startsWith('#')) {
            e.preventDefault();
            const target = document.querySelector(href);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                    mobileMenu.classList.add('hidden');
                }
            }
        }
    });
});

// Set footer year
const footerYear = document.getElementById('footer-year');
if (footerYear) {
    footerYear.textContent = new Date().getFullYear();
}

// Log page load
console.log('üè† Home page loaded successfully');
console.log('üìç Current URL:', window.location.href);
console.log('‚è∞ Loaded at:', new Date().toLocaleString());
</script> </body> </html> </body> </html> 

<!--
Perf:
Exec: 5.56ms
Memory: 0.08MB
Peak: 0.58MB
Cache: ENABLED
Time: 2026-01-03 14:21:48
-->